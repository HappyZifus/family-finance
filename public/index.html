<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Семейные финансы</title>
<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin: 0; background: #f2f2f2; }
header { height: 60px; background: #3a6ea5; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; }

/* Статистика */
#monthStats, #statisticsBlocks { display: flex; justify-content: space-between; margin: 10px 20px; gap: 10px; flex-wrap: wrap; }
.stat-block { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; font-size: 18px; font-weight: bold; }
.stat-value { font-size: 24px; margin-top:5px; color: #3a6ea5; }

.top-selectors { display: flex; justify-content: space-around; margin: 10px 20px; gap: 20px; }
.selector-block { flex: 1; background: #fff; border: 1px solid #E0E0E0; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border-radius: 8px; padding: 15px; text-align: center; font-size: 18px; cursor: pointer; }
.selector-block.active { border: 2px solid #3a6ea5; background: #3a6ea5; color: white; }
.selector-block select { width: 100%; font-size:16px; }

.headers { display: flex; gap: 20px; margin: 10px 20px; }
.headers div { flex: 1; background: #F7F7F7; padding: 12px; text-align: center; font-weight: bold; border-radius: 8px 8px 0 0; }

.input-blocks { display: flex; gap: 20px; margin: 0 20px 20px 20px; }
.input-block { flex: 1; background: #fff; border: 1px solid #E0E0E0; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 10px; }

.income-line { display: flex; gap: 10px; align-items: center; margin-bottom:6px; }
.income-line input[type="text"] { flex: 2; padding:6px; }
.income-line input[type="number"] { flex: 1; padding:6px; }
.income-line input[type="range"] { flex: 0.3; height:6px; accent-color: #3a6ea5; }

.expense-line, .extra-line { display: flex; gap: 10px; align-items: center; margin-bottom: 4px; }
.expense-line input, .extra-line input { flex: 1; padding:6px; }
.individual-expense { background: #e0f0ff; }
.comment-black { background-color: black; color: white; padding: 4px; border-radius: 4px; }

#familyExpenseBlock { margin-top: 10px; font-weight: bold; background: #f0f8ff; padding: 10px; border-radius: 6px; }

#statistics { margin: 20px; }

#cashAvailableDiv { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
#cashAvailableDiv input { flex:1; padding:6px; }
#correctionDiv { display:flex; gap:5px; align-items:center; margin-bottom:10px; }
#correctionDiv input { flex:1; padding:6px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = "https://YOUR_PROJECT.supabase.co"; // замените на свой URL
const supabaseKey = "YOUR_ANON_KEY"; // замените на свой anon key
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// Глобальные массивы
let Income = [];
let Payable = [];
let TotalCash = {};
let FairSpend = [];
let FamilyMembers = ['me','wife'];
let currentPerson = 'me';
let standardComments = ["Voldo Fuel","Volvo Servis","Vadaks utilities","Pension fond","Vadaks Serviss"];

// ----------------- Вспомогательные функции -----------------

// Создание полей
function initIncomeFields() {
  const container = document.getElementById("incomeFields");
  container.innerHTML = '';
  for(let i=0;i<3;i++){
    const div = document.createElement('div');
    div.classList.add('income-line');
    div.innerHTML = `<input type="text" class="income-source" placeholder="Источник">
                     <input type="number" class="income-amount" placeholder="Сумма (€)">
                     <input type="range" class="income-type" min="0" max="1" step="1">`;
    container.appendChild(div);
  }
}
function initPersonalExpenses() {
  const container = document.getElementById("personalExpenses");
  container.innerHTML = '';
  for(let i=0;i<10;i++){
    const div = document.createElement('div');
    div.classList.add('expense-line');
    if(i<5){
      div.innerHTML = `<input type="number" class="personal-expense individual-expense" placeholder="Индивидуальная трата (€)">
                       <select class="personal-comment comment-black"><option value="">--</option>${standardComments.map(c=>`<option>${c}</option>`).join('')}</select>`;
    } else {
      div.innerHTML = `<input type="number" class="personal-expense individual-expense" placeholder="Индивидуальная трата (€)">
                       <input type="text" class="personal-comment" placeholder="Комментарий">`;
    }
    container.appendChild(div);
  }
}
function initExtraExpenses() {
  const container = document.getElementById("extraExpenses");
  container.innerHTML = '';
  for(let i=0;i<10;i++){
    const div = document.createElement('div');
    div.classList.add('extra-line');
    if(i<5){
      div.innerHTML = `<input type="number" class="extra-expense" placeholder="Сумма (€)">
                       <select class="extra-comment comment-black"><option value="">--</option>${standardComments.map(c=>`<option>${c}</option>`).join('')}</select>`;
    } else {
      div.innerHTML = `<input type="number" class="extra-expense" placeholder="Сумма (€)">
                       <input type="text" class="extra-comment" placeholder="Комментарий">`;
    }
    container.appendChild(div);
  }
}

// ----------------- Загрузка данных -----------------

async function loadDataFromSupabase() {
  const { data: incomeData } = await supabase.from('income').select('*');
  const { data: payableData } = await supabase.from('payable').select('*');
  const { data: cashData } = await supabase.from('cash').select('*');

  Income = incomeData || [];
  Payable = payableData || [];
  TotalCash = {};
  cashData?.forEach(c => {
    if (!TotalCash[c.person]) TotalCash[c.person] = {};
    TotalCash[c.person][c.month] = c.amount;
  });

  selectPerson(currentPerson);
}

// ----------------- Сохранение данных -----------------

async function saveDataToSupabase() {
  if (Income.length > 0) await supabase.from('income').upsert(Income);
  if (Payable.length > 0) await supabase.from('payable').upsert(Payable);

  const cashArray = [];
  for (let person in TotalCash) {
    for (let month in TotalCash[person]) {
      cashArray.push({ person, month: +month, amount: TotalCash[person][month] });
    }
  }
  if (cashArray.length > 0) await supabase.from('cash').upsert(cashArray);
}

// ----------------- Выбор пользователя -----------------

document.getElementById('personMe').addEventListener('click', ()=>selectPerson('me'));
document.getElementById('personWife').addEventListener('click', ()=>selectPerson('wife'));
function selectPerson(person){
  currentPerson = person;
  document.getElementById('personMe').classList.toggle('active', person==='me');
  document.getElementById('personWife').classList.toggle('active', person==='wife');
  loadData();
}

// ----------------- Сохранение данных из полей -----------------

function attachInputListeners(){
  document.querySelectorAll('#incomeFields input, #personalExpenses input, #personalExpenses select, #extraExpenses input, #extraExpenses select, #manual-total')
    .forEach(input=>input.addEventListener('input', saveData));
}

async function saveData(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;

  // Доходы
  document.querySelectorAll('#incomeFields div').forEach(div=>{
    const source = div.querySelector('.income-source').value;
    const amount = +div.querySelector('.income-amount').value || 0;
    const type = +div.querySelector('.income-type').value;
    if(source){
      let exist = Income.find(r=>r.year===year && r.month===month && r.person===currentPerson && r.source===source);
      if(exist) exist.amount=amount, exist.type=type;
      else Income.push({year,month,person:currentPerson,source,amount,type});
    }
  });

  // Расходы
  Payable = Payable.filter(r=>!(r.year===year && r.month===month && r.person===currentPerson));
  const manualTotal = +document.getElementById("manual-total").value || 0;
  Payable.push({year,month,person:currentPerson,type:'manualTotal',amount:manualTotal});
  document.querySelectorAll('#personalExpenses div').forEach((div,i)=>{
    const amount = +div.querySelector('.personal-expense').value || 0;
    let comment = i<5?div.querySelector('select').value:div.querySelector('input').value;
    if(amount>0 || comment) Payable.push({year,month,person:currentPerson,type:'personal',amount,comment});
  });
  document.querySelectorAll('#extraExpenses div').forEach((div,i)=>{
    const amount = +div.querySelector('.extra-expense').value || 0;
    let comment=i<5?div.querySelector('select').value:div.querySelector('input').value;
    if(amount>0 || comment) Payable.push({year,month,person:currentPerson,type:'extra',amount,comment});
  });

  // TotalCash
  if(!TotalCash[currentPerson]) TotalCash[currentPerson] = {};
  if(!TotalCash[currentPerson][month]) {
    let prevMonthCash = TotalCash[currentPerson][month-1] || 0;
    TotalCash[currentPerson][month] = prevMonthCash;
  }

  // Пересчёт FairSpend и UI
  updateFairSpend();
  updateFamilyExpense();
  updateMonthStats();
  updateStatistics();
  attachInputListeners();

  await saveDataToSupabase();
}

// ----------------- FairSpend -----------------

function updateFairSpend(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;

  // Общий доход всех членов семьи за год
  const totalIncomeYear = FamilyMembers.reduce((sum,p)=>{
    return sum + Income.filter(r=>r.year===year && r.person===p).reduce((a,b)=>a+b.amount,0);
  },0);

  // Общие семейные расходы текущего месяца
  const manualTotal = +document.getElementById("manual-total").value || 0;
  const personalSum = document.querySelectorAll('#personalExpenses .personal-expense')
                        .length ? [...document.querySelectorAll('#personalExpenses .personal-expense')].reduce((a,e)=>a+(+e.value||0),0) : 0;
  const totalFamilyExpense = manualTotal - personalSum;

  FamilyMembers.forEach(p=>{
    const userIncomeYear = Income.filter(r=>r.year===year && r.person===p).reduce((a,b)=>a+b.amount,0);
    const percentIncome = totalIncomeYear ? userIncomeYear / totalIncomeYear : 0;
    const fair = totalFamilyExpense * percentIncome;
    let exist = FairSpend.find(f=>f.year===year && f.month===month && f.person===p);
    if(exist) exist.fair=fair;
    else FairSpend.push({year,month,person:p,fair});
  });
}

// ----------------- Обновление верхней статистики -----------------

function updateMonthStats(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;

  let startCash = TotalCash[currentPerson][month] || (TotalCash[currentPerson][month-1] || 0);
  document.getElementById("startCash").textContent = startCash.toFixed(2);

  const incomeMonth = Income.filter(r=>r.year===year && r.month===month && r.person===currentPerson).reduce((a,b)=>a+b.amount,0);
  const manualTotal = +document.getElementById("manual-total").value || 0;
  const personalSum = document.querySelectorAll('#personalExpenses .personal-expense').length ? [...document.querySelectorAll('#personalExpenses .personal-expense')].reduce((a,e)=>a+(+e.value||0),0) : 0;

  const endCash = startCash + incomeMonth - (manualTotal - personalSum);
  document.getElementById("endCash").textContent = endCash.toFixed(2);

  // Процент дохода за год
  const totalIncomeYear = FamilyMembers.reduce((sum,p)=>{
    return sum + Income.filter(r=>r.year===year && r.person===p).reduce((a,b)=>a+b.amount,0);
  },0);
  const userIncomeYear = Income.filter(r=>r.year===year && r.person===currentPerson).reduce((a,b)=>a+b.amount,0);
  const percentIncome = totalIncomeYear ? userIncomeYear/totalIncomeYear*100 : 0;
  document.getElementById("incomePercent").textContent = percentIncome.toFixed(1);

  document.getElementById("totalFamilyExpense").textContent = (manualTotal - personalSum).toFixed(2);
  const fair = FairSpend.find(f=>f.year===year && f.month===month && f.person===currentPerson)?.fair||0;
  document.getElementById("fairExpense").textContent = fair.toFixed(2);
  document.getElementById("diffExpense").textContent = ((manualTotal - personalSum) - fair).toFixed(2);
}

// ----------------- Нижняя статистика -----------------

function updateStatistics(){
  const year = +document.getElementById("statsYearSelect").value;
  const container = document.getElementById("statisticsBlocks");
  container.innerHTML='';

  let totalEndCash = 0, totalIncome=0, totalExpense=0;
  let memberStats = {};
  FamilyMembers.forEach(p=>{
    memberStats[p]={income:0,expense:0,fair:0,diff:0,months:0};
    for(let m=1;m<=12;m++){
      const monthIncome = Income.filter(r=>r.year===year && r.month===m && r.person===p).reduce((a,b)=>a+b.amount,0);
      const manualTotal = Payable.find(r=>r.year===year && r.month===m && r.person===p && r.type==='manualTotal')?.amount||0;
      const personal = Payable.filter(r=>r.year===year && r.month===m && r.person===p && r.type==='personal').reduce((a,b)=>a+b.amount,0);
      const monthEndCash = (TotalCash[p]?.[m] || (TotalCash[p]?.[m-1]||0)) + monthIncome - (manualTotal-personal);
      const fair = FairSpend.find(f=>f.year===year && f.month===m && f.person===p)?.fair||0;
      if(monthIncome || manualTotal){
        memberStats[p].income += monthIncome;
        memberStats[p].expense += (manualTotal-personal);
        memberStats[p].fair += fair;
        memberStats[p].diff += (manualTotal-personal - fair);
        memberStats[p].months++;
      }
      totalEndCash += monthEndCash;
      totalIncome += monthIncome;
      totalExpense += (manualTotal-personal);
    }
  });

  container.innerHTML += `<div class="stat-block">Общий остаток: ${totalEndCash.toFixed(2)} €</div>`;
  container.innerHTML += `<div class="stat-block">Средний доход: ${(totalIncome/12).toFixed(2)} €</div>`;
  container.innerHTML += `<div class="stat-block">Средний расход: ${(totalExpense/12).toFixed(2)} €</div>`;

  FamilyMembers.forEach(p=>{
    container.innerHTML += `<div class="stat-block">
      <b>${p}</b><br>
      Доход: ${memberStats[p].income.toFixed(2)} €<br>
      Расходы: ${memberStats[p].expense.toFixed(2)} €<br>
      Честная доля: ${memberStats[p].fair.toFixed(2)} €<br>
      Разница: ${memberStats[p].diff.toFixed(2)} €
    </div>`;
  });
}

// ----------------- Инициализация -----------------

window.addEventListener('DOMContentLoaded', async () => {
  document.getElementById("addIncome").addEventListener('click',()=>{initIncomeFields();attachInputListeners();});
  document.getElementById("yearSelect").addEventListener('change',saveData);
  document.getElementById("monthSelect").addEventListener('change',saveData);
  document.getElementById("statsYearSelect").addEventListener('change',updateStatistics);
  initIncomeFields();
  initPersonalExpenses();
  initExtraExpenses();
  attachInputListeners();
  await loadDataFromSupabase();
});
</script>
</head>
<body>
<header>Семейные финансы</header>

<div class="top-selectors">
  <div class="selector-block active" id="personMe">Я</div>
  <div class="selector-block" id="personWife">Супруга</div>
  <div class="selector-block">
    Год: <select id="yearSelect">${[2024,2025].map(y=>`<option>${y}</option>`).join('')}</select>
  </div>
  <div class="selector-block">
    Месяц: <select id="monthSelect">${Array.from({length:12},(_,i)=>`<option>${i+1}</option>`).join('')}</select>
  </div>
</div>

<div id="monthStats">
  <div class="stat-block">В наличии: <span id="startCash">0</span> €</div>
  <div class="stat-block">На конец: <span id="endCash">0</span> €</div>
  <div class="stat-block">Процент дохода: <span id="incomePercent">0</span> %</div>
  <div class="stat-block">Общие семейные: <span id="totalFamilyExpense">0</span> €</div>
  <div class="stat-block">Честная доля: <span id="fairExpense">0</span> €</div>
  <div class="stat-block">Разница: <span id="diffExpense">0</span> €</div>
</div>

<div class="headers">
  <div>Доходы</div>
  <div>Индивидуальные расходы</div>
  <div>Общие расходы</div>
</div>

<div class="input-blocks">
  <div class="input-block" id="incomeFields"></div>
  <div class="input-block" id="personalExpenses"></div>
  <div class="input-block" id="extraExpenses"></div>
</div>

<div id="statistics">
  Год для статистики: <select id="statsYearSelect">${[2024,2025].map(y=>`<option>${y}</option>`).join('')}</select>
  <div id="statisticsBlocks"></div>
</div>

<div style="margin:20px;">
  <button id="addIncome">Добавить доход</button>
</div>
</body>
</html>
