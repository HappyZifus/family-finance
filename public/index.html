<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Семейные финансы</title>
<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin: 0; background: #f2f2f2; }
header { height: 60px; background: #3a6ea5; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; }

/* Статистика */
#monthStats, #statisticsBlocks { display: flex; justify-content: space-between; margin: 10px 20px; gap: 10px; flex-wrap: wrap; }
.stat-block { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; font-size: 18px; font-weight: bold; }
.stat-value { font-size: 24px; margin-top:5px; color: #3a6ea5; }

.top-selectors { display: flex; justify-content: space-around; margin: 10px 20px; gap: 20px; }
.selector-block { flex: 1; background: #fff; border: 1px solid #E0E0E0; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border-radius: 8px; padding: 15px; text-align: center; font-size: 18px; cursor: pointer; }
.selector-block.active { border: 2px solid #3a6ea5; background: #3a6ea5; color: white; }
.selector-block select { width: 100%; font-size:16px; }

.headers { display: flex; gap: 20px; margin: 10px 20px; }
.headers div { flex: 1; background: #F7F7F7; padding: 12px; text-align: center; font-weight: bold; border-radius: 8px 8px 0 0; }

.input-blocks { display: flex; gap: 20px; margin: 0 20px 20px 20px; }
.input-block { flex: 1; background: #fff; border: 1px solid #E0E0E0; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 10px; }

.income-line { display: flex; gap: 10px; align-items: center; margin-bottom:6px; }
.income-line input[type="text"] { flex: 2; padding:6px; }
.income-line input[type="number"] { flex: 1; padding:6px; }
.income-line input[type="range"] { flex: 0.3; height:6px; accent-color: #3a6ea5; }

.expense-line, .extra-line { display: flex; gap: 10px; align-items: center; margin-bottom: 4px; }
.expense-line input, .extra-line input { flex: 1; padding:6px; }
.individual-expense { background: #e0f0ff; }
.comment-black { background-color: black; color: white; padding: 4px; border-radius: 4px; }

#familyExpenseBlock { margin-top: 10px; font-weight: bold; background: #f0f8ff; padding: 10px; border-radius: 6px; }

#statistics { margin: 20px; }

#cashAvailableDiv { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
#cashAvailableDiv input { flex:1; padding:6px; }
#correctionDiv { display:flex; gap:5px; align-items:center; margin-bottom:10px; }
#correctionDiv input { flex:1; padding:6px; }
</style>
</head>
<body>

<header>Семейные финансы</header>

<div id="monthStats">
  <div class="stat-block">В наличии<br><span class="stat-value" id="startCash">0</span> €</div>
  <div class="stat-block">Остаток на конец<br><span class="stat-value" id="endCash">0</span> €</div>
  <div class="stat-block">Процент дохода<br><span class="stat-value" id="incomePercent">0</span>%</div>
  <div class="stat-block">Общие семейные<br><span class="stat-value" id="totalFamilyExpense">0</span> €</div>
  <div class="stat-block">Честная доля<br><span class="stat-value" id="fairExpense">0</span> €</div>
  <div class="stat-block">Разница<br><span class="stat-value" id="diffExpense">0</span> €</div>
</div>

<section id="input">
  <div class="top-selectors">
    <div class="selector-block" id="personMe">Леша</div>
    <div class="selector-block" id="personWife">Лена</div>
    <div class="selector-block">
      <label>Год:</label>
      <select id="yearSelect"><option value="2025">2025</option><option value="2026">2026</option></select>
    </div>
    <div class="selector-block">
      <label>Месяц:</label>
      <select id="monthSelect">
        <option>Январь</option><option>Февраль</option><option>Март</option><option>Апрель</option>
        <option>Май</option><option>Июнь</option><option>Июль</option><option>Август</option>
        <option>Сентябрь</option><option>Октябрь</option><option>Ноябрь</option><option>Декабрь</option>
      </select>
    </div>
  </div>

  <div class="headers">
    <div>Доход</div>
    <div>Расход</div>
  </div>

  <div class="input-blocks">
    <div class="input-block" id="incomeBlock">
      <div id="cashAvailableDiv">
        <label>В наличии (€):</label>
        <input type="number" id="cashAvailable" disabled>
      </div>
      <div id="correctionDiv">
        <label>Коррекция (€):</label>
        <input type="number" id="correctionValue" placeholder="0">
        <button id="applyCorrection">Применить</button>
      </div>
      <div id="incomeFields"></div>
      <button id="addIncome">Добавить доход</button>
    </div>

    <div class="input-block" id="expenseBlock">
      <label>Общая сумма трат (€)</label>
      <input type="number" id="manual-total" placeholder="Общая сумма трат">
      <div id="familyExpenseBlock">Семейные траты: 0 €</div>

      <h4>Индивидуальные траты</h4>
      <div id="personalExpenses"></div>

      <h4>Дополнительные общие траты (для информации)</h4>
      <div id="extraExpenses"></div>
    </div>
  </div>
</section>

<section id="statistics">
  <div style="margin:10px 20px;">
    <label>Год:</label>
    <select id="statsYearSelect">
      <option value="2025">2025</option>
      <option value="2026">2026</option>
    </select>
  </div>
  <div id="statisticsBlocks"></div>
</section>

<script>
let Income = [];
let Payable = [];
let TotalCash = {};
let FamilyMembers = ['me','wife'];
let FairSpend = [];
let standardComments = ["Voldo Fuel","Volvo Servis","Vadaks utilities","Pension fond","Vadaks Serviss"];

function initJanuary() {
  if(!Income.length){
    Income.push({year:2025,month:1,person:'me',source:'Зарплата',amount:3000,type:1});
    Income.push({year:2025,month:1,person:'wife',source:'Зарплата',amount:2500,type:1});
  }
  if(!Payable.length){
    Payable.push({year:2025,month:1,person:'me',type:'personal',amount:100,comment:'Voldo Fuel'});
    Payable.push({year:2025,month:1,person:'me',type:'personal',amount:50,comment:'Volvo Servis'});
    Payable.push({year:2025,month:1,person:'wife',type:'personal',amount:80,comment:'Vadaks utilities'});
  }
  if(!TotalCash['me']) TotalCash['me'] = {1:500};
  if(!TotalCash['wife']) TotalCash['wife'] = {1:300};
}

let currentPerson = 'me';
document.getElementById('personMe').addEventListener('click', ()=>selectPerson('me'));
document.getElementById('personWife').addEventListener('click', ()=>selectPerson('wife'));

function selectPerson(person){
  currentPerson = person;
  document.getElementById('personMe').classList.toggle('active', person==='me');
  document.getElementById('personWife').classList.toggle('active', person==='wife');
  loadData();
}

function initIncomeFields() {
  const container = document.getElementById("incomeFields");
  container.innerHTML = '';
  for(let i=0;i<3;i++){
    const div = document.createElement('div');
    div.classList.add('income-line');
    div.innerHTML = `<input type="text" class="income-source" placeholder="Источник">
                     <input type="number" class="income-amount" placeholder="Сумма (€)">
                     <input type="range" class="income-type" min="0" max="1" step="1">`;
    container.appendChild(div);
  }
}

function initPersonalExpenses() {
  const container = document.getElementById("personalExpenses");
  container.innerHTML = '';
  for(let i=0;i<10;i++){
    const div = document.createElement('div');
    div.classList.add('expense-line');
    if(i<5){
      div.innerHTML = `<input type="number" class="personal-expense individual-expense" placeholder="Индивидуальная трата (€)">
                       <select class="personal-comment comment-black"><option value="">--</option>${standardComments.map(c=>`<option>${c}</option>`).join('')}</select>`;
    } else {
      div.innerHTML = `<input type="number" class="personal-expense individual-expense" placeholder="Индивидуальная трата (€)">
                       <input type="text" class="personal-comment" placeholder="Комментарий">`;
    }
    container.appendChild(div);
  }
}

function initExtraExpenses() {
  const container = document.getElementById("extraExpenses");
  container.innerHTML = '';
  for(let i=0;i<10;i++){
    const div = document.createElement('div');
    div.classList.add('extra-line');
    if(i<5){
      div.innerHTML = `<input type="number" class="extra-expense" placeholder="Сумма (€)">
                       <select class="extra-comment comment-black"><option value="">--</option>${standardComments.map(c=>`<option>${c}</option>`).join('')}</select>`;
    } else {
      div.innerHTML = `<input type="number" class="extra-expense" placeholder="Сумма (€)">
                       <input type="text" class="extra-comment" placeholder="Комментарий">`;
    }
    container.appendChild(div);
  }
}

// --- Слушатели ---
function attachInputListeners(){
  document.querySelectorAll('#incomeFields input, #personalExpenses input, #personalExpenses select, #extraExpenses input, #extraExpenses select, #manual-total')
    .forEach(input=>input.addEventListener('input', saveData));
}

document.getElementById("addIncome").addEventListener('click',()=>{initIncomeFields();attachInputListeners();});
document.getElementById("yearSelect").addEventListener('change', loadData);
document.getElementById("monthSelect").addEventListener('change', loadData);
document.getElementById("statsYearSelect").addEventListener('change', updateStatistics);

document.getElementById("applyCorrection").addEventListener('click',()=>{
  let val = +document.getElementById("correctionValue").value || 0;
  const month = document.getElementById("monthSelect").selectedIndex+1;
  if(!TotalCash[currentPerson]) TotalCash[currentPerson] = {};
  if(!TotalCash[currentPerson][month]) TotalCash[currentPerson][month] = 0;
  TotalCash[currentPerson][month] += val;
  loadData();
});

// --- Сохранение данных ---
function saveData(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;

  // Доходы
  document.querySelectorAll('#incomeFields div').forEach(div=>{
    const source = div.querySelector('.income-source').value;
    const amount = +div.querySelector('.income-amount').value || 0;
    const type = +div.querySelector('.income-type').value;
    if(source){
      let exist = Income.find(r=>r.year===year && r.month===month && r.person===currentPerson && r.source===source);
      if(exist) exist.amount=amount, exist.type=type;
      else Income.push({year,month,person:currentPerson,source,amount,type});
    }
  });

  // Расходы
  Payable = Payable.filter(r=>!(r.year===year && r.month===month && r.person===currentPerson));
  const manualTotal = +document.getElementById("manual-total").value || 0;
  Payable.push({year,month,person:currentPerson,type:'manualTotal',amount:manualTotal});
  document.querySelectorAll('#personalExpenses div').forEach((div,i)=>{
    const amount = +div.querySelector('.personal-expense').value || 0;
    let comment = i<5?div.querySelector('select').value:div.querySelector('input').value;
    if(amount>0 || comment) Payable.push({year,month,person:currentPerson,type:'personal',amount,comment});
  });
  document.querySelectorAll('#extraExpenses div').forEach((div,i)=>{
    const amount = +div.querySelector('.extra-expense').value || 0;
    let comment=i<5?div.querySelector('select').value:div.querySelector('input').value;
    if(amount>0 || comment) Payable.push({year,month,person:currentPerson,type:'extra',amount,comment});
  });

  if(!TotalCash[currentPerson]) TotalCash[currentPerson] = {};
  if(!TotalCash[currentPerson][month]) {
    let prevMonthCash = TotalCash[currentPerson][month-1] || 0;
    TotalCash[currentPerson][month] = prevMonthCash;
  }

  updateFairSpend();
  updateFamilyExpense();
  updateMonthStats();
  updateStatistics();
}

function updateFairSpend(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;

  const totalIncomeYearAll = Income.filter(r=>r.year===year).reduce((sum,r)=>sum+r.amount,0);
  const totalFamilyExpenseAll = FamilyMembers.reduce((sum,p)=>{
    const manual = Payable.find(r=>r.year===year && r.month===month && r.person===p && r.type==='manualTotal')?.amount||0;
    const personal = Payable.filter(r=>r.year===year && r.month===month && r.person===p && r.type==='personal').reduce((a,b)=>a+b.amount,0);
    return sum + (manual-personal);
  },0);

  FamilyMembers.forEach(p=>{
    const userIncomeYear = Income.filter(r=>r.year===year && r.person===p).reduce((a,b)=>a+b.amount,0);
    const percentIncome = totalIncomeYearAll? userIncomeYear/totalIncomeYearAll : 0;
    const fair = totalFamilyExpenseAll * percentIncome;
    let exist = FairSpend.find(f=>f.year===year && f.month===month && f.person===p);
    if(exist) exist.fair=fair;
    else FairSpend.push({year,month,person:p,fair});
  });
}

function updateFamilyExpense(){
  const manualTotal = +document.getElementById("manual-total").value || 0;
  let personalSum = 0;
  document.querySelectorAll('#personalExpenses .personal-expense').forEach(e=>personalSum+=+e.value||0);
  let userFamilyExpense = manualTotal-personalSum;
  document.getElementById('familyExpenseBlock').textContent = `Семейные траты: ${userFamilyExpense.toFixed(2)} €`;
}

function loadData(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;

  initIncomeFields();
  initPersonalExpenses();
  initExtraExpenses();

  let startCash = TotalCash[currentPerson][month] || (TotalCash[currentPerson][month-1] || 0);
  document.getElementById("cashAvailable").value = startCash;

  const incomeDivs = document.querySelectorAll('#incomeFields div');
  Income.filter(r=>r.year===year && r.month===month && r.person===currentPerson).forEach((inc,i)=>{
    if(incomeDivs[i]){
      incomeDivs[i].querySelector('.income-source').value = inc.source;
      incomeDivs[i].querySelector('.income-amount').value = inc.amount;
      incomeDivs[i].querySelector('.income-type').value = inc.type;
    }
  });

  const manual = Payable.find(r=>r.year===year && r.month===month && r.person===currentPerson && r.type==='manualTotal');
  document.getElementById("manual-total").value = manual?.amount || 0;

  // Индивидуальные
  let personalLines = document.querySelectorAll('#personalExpenses div');
  Payable.filter(r=>r.year===year && r.month===month && r.person===currentPerson && r.type==='personal').forEach((p,i)=>{
    if(personalLines[i]){
      personalLines[i].querySelector('.personal-expense').value = p.amount;
      if(i<5) personalLines[i].querySelector('select').value=p.comment;
      else personalLines[i].querySelector('input').value=p.comment;
    }
  });

  attachInputListeners();
  saveData();
}

function updateMonthStats(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;

  const startCash = TotalCash[currentPerson][month] || 0;
  const incomesMonth = Income.filter(r=>r.year===year && r.month===month && r.person===currentPerson).reduce((a,b)=>a+b.amount,0);
  const manualTotal = +document.getElementById("manual-total").value || 0;
  const personalSum = document.querySelectorAll('#personalExpenses .personal-expense').length ?
    Array.from(document.querySelectorAll('#personalExpenses .personal-expense')).reduce((a,b)=>a+(+b.value||0),0) : 0;

  const endCash = startCash + incomesMonth - (manualTotal - personalSum);
  document.getElementById("startCash").textContent = startCash.toFixed(2);
  document.getElementById("endCash").textContent = endCash.toFixed(2);

  const yearIncomeAll = Income.filter(r=>r.year===year).reduce((a,b)=>a+b.amount,0);
  const userIncomeYear = Income.filter(r=>r.year===year && r.person===currentPerson).reduce((a,b)=>a+b.amount,0);
  const percentIncome = yearIncomeAll? (userIncomeYear/yearIncomeAll*100) : 0;
  document.getElementById("incomePercent").textContent = percentIncome.toFixed(2);

  const totalFamilyExpense = FamilyMembers.reduce((sum,p)=>{
    const manual = Payable.find(r=>r.year===year && r.month===month && r.person===p && r.type==='manualTotal')?.amount||0;
    const personal = Payable.filter(r=>r.year===year && r.month===month && r.person===p && r.type==='personal').reduce((a,b)=>a+b.amount,0);
    return sum + (manual-personal);
  },0);
  document.getElementById("totalFamilyExpense").textContent = totalFamilyExpense.toFixed(2);

  const fair = FairSpend.find(f=>f.year===year && f.month===month && f.person===currentPerson)?.fair || 0;
  document.getElementById("fairExpense").textContent = fair.toFixed(2);

  document.getElementById("diffExpense").textContent = (totalFamilyExpense-fair).toFixed(2);
}

function updateStatistics(){
  const statsYear = +document.getElementById("statsYearSelect").value;
  const container = document.getElementById("statisticsBlocks");
  container.innerHTML = '';

  let totalCash = 0, totalIncome=0, totalExpense=0;
  FamilyMembers.forEach(p=>{
    const userIncome = Income.filter(r=>r.year===statsYear && r.person===p).reduce((a,b)=>a+b.amount,0);
    const userExpense = Payable.filter(r=>r.year===statsYear && r.person===p && r.type==='personal').reduce((a,b)=>a+b.amount,0) +
                        Payable.filter(r=>r.year===statsYear && r.person===p && r.type==='manualTotal').reduce((a,b)=>a+b.amount,0);
    totalIncome+=userIncome;
    totalExpense+=userExpense;
    const fair = FairSpend.find(f=>f.year===statsYear && f.person===p)?.fair || 0;
    const diff = userExpense-fair;

    const div = document.createElement('div');
    div.classList.add('stat-block');
    div.innerHTML = `<b>${p}</b><br>Доход: ${userIncome.toFixed(2)}<br>Расход: ${userExpense.toFixed(2)}<br>Честная доля: ${fair.toFixed(2)}<br>Разница: ${diff.toFixed(2)}`;
    container.appendChild(div);
  });

  const totalDiv = document.createElement('div');
  totalDiv.classList.add('stat-block');
  totalDiv.innerHTML = `<b>Всего семья</b><br>Общий доход: ${totalIncome.toFixed(2)}<br>Общий расход: ${totalExpense.toFixed(2)}<br>Средний доход: ${(totalIncome/FamilyMembers.length).toFixed(2)}<br>Средний расход: ${(totalExpense/FamilyMembers.length).toFixed(2)}`;
  container.appendChild(totalDiv);
}

// Инициализация
initJanuary();
selectPerson('me');
</script>

</body>
</html>
