<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Семейные финансы</title>
<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin:0; background:#f2f2f2; }
header { height:60px; background:#3a6ea5; color:white; display:flex; align-items:center; justify-content:center; font-size:20px; }

/* Статистика */
#monthStats, #statisticsBlocks { display:flex; justify-content:space-between; margin:10px 20px; gap:10px; flex-wrap:wrap; }
.stat-block { flex:1; background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.08); text-align:center; font-size:18px; font-weight:bold; }
.stat-value { font-size:24px; margin-top:5px; color:#3a6ea5; }

.top-selectors { display:flex; justify-content:space-around; margin:10px 20px; gap:20px; }
.selector-block { flex:1; background:#fff; border:1px solid #E0E0E0; box-shadow:0 4px 12px rgba(0,0,0,0.04); border-radius:8px; padding:15px; text-align:center; font-size:18px; cursor:pointer; }
.selector-block.active { border:2px solid #3a6ea5; background:#3a6ea5; color:white; }
.selector-block select { width:100%; font-size:16px; }

.headers { display:flex; gap:20px; margin:10px 20px; }
.headers div { flex:1; background:#F7F7F7; padding:12px; text-align:center; font-weight:bold; border-radius:8px 8px 0 0; }

.input-blocks { display:flex; gap:20px; margin:0 20px 20px 20px; }
.input-block { flex:1; background:#fff; border:1px solid #E0E0E0; box-shadow:0 4px 12px rgba(0,0,0,0.04); border-radius:8px; padding:20px; display:flex; flex-direction:column; gap:10px; }

.income-line, .expense-line, .extra-line { display:flex; gap:10px; align-items:center; margin-bottom:6px; }
.income-line input[type="text"], .income-line input[type="number"], .expense-line input, .extra-line input { flex:1; padding:6px; }
.income-line input[type="range"] { flex:0.3; height:6px; accent-color:#3a6ea5; }

.individual-expense { background:#e0f0ff; }
.comment-black { background-color:black; color:white; padding:4px; border-radius:4px; }

#familyExpenseBlock { margin-top:10px; font-weight:bold; background:#f0f8ff; padding:10px; border-radius:6px; }

#statistics { margin:20px; }

#cashAvailableDiv, #correctionDiv { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
#cashAvailableDiv input, #correctionDiv input { flex:1; padding:6px; }
</style>
</head>
<body>

<header>Семейные финансы</header>

<div id="monthStats">
  <div class="stat-block">В наличии<br><span class="stat-value" id="startCash">0</span> €</div>
  <div class="stat-block">Остаток на конец<br><span class="stat-value" id="endCash">0</span> €</div>
  <div class="stat-block">Процент дохода<br><span class="stat-value" id="incomePercent">0</span>%</div>
  <div class="stat-block">Общие семейные<br><span class="stat-value" id="totalFamilyExpense">0</span> €</div>
  <div class="stat-block">Честная доля<br><span class="stat-value" id="fairExpense">0</span> €</div>
  <div class="stat-block">Разница<br><span class="stat-value" id="diffExpense">0</span> €</div>
</div>

<section id="input">
  <div class="top-selectors">
    <div class="selector-block" id="personMe">Леша</div>
    <div class="selector-block" id="personWife">Лена</div>
    <div class="selector-block">
      <label>Год:</label>
      <select id="yearSelect"><option value="2025">2025</option><option value="2026">2026</option></select>
    </div>
    <div class="selector-block">
      <label>Месяц:</label>
      <select id="monthSelect">
        <option>Январь</option><option>Февраль</option><option>Март</option><option>Апрель</option>
        <option>Май</option><option>Июнь</option><option>Июль</option><option>Август</option>
        <option>Сентябрь</option><option>Октябрь</option><option>Ноябрь</option><option>Декабрь</option>
      </select>
    </div>
  </div>

  <div class="headers">
    <div>Доход</div>
    <div>Расход</div>
  </div>

  <div class="input-blocks">
    <div class="input-block" id="incomeBlock">
      <div id="cashAvailableDiv">
        <label>В наличии (€):</label>
        <input type="number" id="cashAvailable" disabled>
      </div>
      <div id="correctionDiv">
        <label>Коррекция (€):</label>
        <input type="number" id="correctionValue" placeholder="0">
        <button id="applyCorrection">Применить</button>
      </div>
      <div id="incomeFields"></div>
      <button id="addIncome">Добавить доход</button>
    </div>

    <div class="input-block" id="expenseBlock">
      <label>Общая сумма трат (€)</label>
      <input type="number" id="manual-total" placeholder="Общая сумма трат">
      <div id="familyExpenseBlock">Семейные траты: 0 €</div>

      <h4>Индивидуальные траты</h4>
      <div id="personalExpenses"></div>

      <h4>Дополнительные общие траты (для информации)</h4>
      <div id="extraExpenses"></div>
    </div>
  </div>
</section>

<section id="statistics">
  <div style="margin:10px 20px;">
    <label>Год:</label>
    <select id="statsYearSelect">
      <option value="2025">2025</option>
      <option value="2026">2026</option>
    </select>
  </div>
  <div id="statisticsBlocks"></div>
</section>

<script type="module">
// --- Подключение Supabase ---

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://mlkkehhdymhqctxlioov.supabase.co'
const supabaseKey = process.env.SUPABASE_KEY
const supabase = createClient(supabaseUrl, supabaseKey)

// --- Переменные ---
let currentPerson = 'me';
let FamilyMembers = ['me','wife'];
let standardComments = ["Voldo Fuel","Volvo Servis","Vadaks utilities","Pension fond","Vadaks Serviss"];

// --- Инициализация интерфейса ---
function initIncomeFields(){ const container = document.getElementById("incomeFields"); container.innerHTML=''; for(let i=0;i<3;i++){ const div = document.createElement('div'); div.classList.add('income-line'); div.innerHTML=`<input type="text" class="income-source" placeholder="Источник"><input type="number" class="income-amount" placeholder="Сумма (€)"><input type="range" class="income-type" min="0" max="1" step="1">`; container.appendChild(div); } }
function initPersonalExpenses(){ const container = document.getElementById("personalExpenses"); container.innerHTML=''; for(let i=0;i<10;i++){ const div=document.createElement('div'); div.classList.add('expense-line'); if(i<5){ div.innerHTML=`<input type="number" class="personal-expense individual-expense" placeholder="Индивидуальная трата (€)"><select class="personal-comment comment-black"><option value="">--</option>${standardComments.map(c=>`<option>${c}</option>`).join('')}</select>`; } else { div.innerHTML=`<input type="number" class="personal-expense individual-expense" placeholder="Индивидуальная трата (€)"><input type="text" class="personal-comment" placeholder="Комментарий">`; } container.appendChild(div); } }
function initExtraExpenses(){ const container = document.getElementById("extraExpenses"); container.innerHTML=''; for(let i=0;i<10;i++){ const div=document.createElement('div'); div.classList.add('extra-line'); if(i<5){ div.innerHTML=`<input type="number" class="extra-expense" placeholder="Сумма (€)"><select class="extra-comment comment-black"><option value="">--</option>${standardComments.map(c=>`<option>${c}</option>`).join('')}</select>`; } else { div.innerHTML=`<input type="number" class="extra-expense" placeholder="Сумма (€)"><input type="text" class="extra-comment" placeholder="Комментарий">`; } container.appendChild(div); } }

// --- Слушатели ---
document.getElementById('personMe').addEventListener('click',()=>selectPerson('me'));
document.getElementById('personWife').addEventListener('click',()=>selectPerson('wife'));
document.getElementById("addIncome").addEventListener('click',()=>{initIncomeFields();});
document.getElementById("applyCorrection").addEventListener('click',applyCorrection);
document.getElementById("yearSelect").addEventListener('change', loadData);
document.getElementById("monthSelect").addEventListener('change', loadData);
document.getElementById("statsYearSelect").addEventListener('change', updateStatistics);

function selectPerson(p){currentPerson=p; document.getElementById('personMe').classList.toggle('active',p==='me'); document.getElementById('personWife').classList.toggle('active',p==='wife'); loadData(); }
function applyCorrection(){ let val=+document.getElementById("correctionValue").value||0; const month=document.getElementById("monthSelect").selectedIndex+1; supabase.from('cash').upsert({person:currentPerson,month,year:+document.getElementById("yearSelect").value,cash:val},{onConflict:['person','month','year']}).then(loadData); }

// --- Загрузка данных с Supabase ---
async function loadData(){
  const year = +document.getElementById("yearSelect").value;
  const month = document.getElementById("monthSelect").selectedIndex+1;
  initIncomeFields(); initPersonalExpenses(); initExtraExpenses();

  // --- Получаем доходы ---
  const {data:Income} = await supabase.from('income').select('*').eq('year',year).eq('month',month);
  const {data:Payable} = await supabase.from('payable').select('*').eq('year',year).eq('month',month);

  // --- Вычисления ---
  const startCash = Income.find(i=>i.person===currentPerson)?.cash || 0;
  document.getElementById("cashAvailable").value=startCash;

  // Слайдеры и поля доходов
  const incomeDivs = document.querySelectorAll('#incomeFields div');
  Income.filter(i=>i.person===currentPerson).forEach((inc,i)=>{ if(incomeDivs[i]){ incomeDivs[i].querySelector('.income-source').value=inc.source; incomeDivs[i].querySelector('.income-amount').value=inc.amount; incomeDivs[i].querySelector('.income-type').value=inc.type; } });

  // Расходы
  document.getElementById("manual-total").value=Payable.find(r=>r.person===currentPerson && r.type==='manualTotal')?.amount||0;
  updateFamilyExpense(Payable);
  updateMonthStats(Income,Payable);
  updateStatistics();
}

function updateFamilyExpense(Payable){
  const manualTotal=+document.getElementById("manual-total").value||0;
  let personalSum=Payable?.filter(p=>p.type==='personal' && p.person===currentPerson).reduce((a,b)=>a+b.amount,0)||0;
  document.getElementById('familyExpenseBlock').textContent=`Семейные траты: ${(manualTotal-personalSum).toFixed(2)} €`;
}

// --- Статистика ---
function updateMonthStats(Income,Payable){
  const year=+document.getElementById("yearSelect").value;
  const month=document.getElementById("monthSelect").selectedIndex+1;
  const startCash = Income.find(i=>i.person===currentPerson)?.cash || 0;
  document.getElementById("startCash").textContent=startCash.toFixed(2);

  const incomeMonth = Income.filter(i=>i.person===currentPerson).reduce((a,b)=>a+b.amount,0);
  const manualTotal = +document.getElementById("manual-total").value ||0;
  const personalSum = Payable?.filter(p=>p.type==='personal' && p.person===currentPerson).reduce((a,b)=>a+b.amount,0)||0;
  const endCash = startCash + incomeMonth - (manualTotal-personalSum);
  document.getElementById("endCash").textContent=endCash.toFixed(2);

  // --- Процент дохода за год ---
  const totalIncomeYear = Income.filter(i=>i.year===year).reduce((a,b)=>a+b.amount,0);
  const userIncomeYear = Income.filter(i=>i.person===currentPerson).reduce((a,b)=>a+b.amount,0);
  const percentIncome = totalIncomeYear? (userIncomeYear/totalIncomeYear*100):0;
  document.getElementById("incomePercent").textContent=percentIncome.toFixed(1);

  const totalFamilyExpense = manualTotal-personalSum;
  document.getElementById("totalFamilyExpense").textContent=totalFamilyExpense.toFixed(2);

  const fair = totalFamilyExpense*(percentIncome/100);
  document.getElementById("fairExpense").textContent=fair.toFixed(2);
  document.getElementById("diffExpense").textContent=(totalFamilyExpense-fair).toFixed(2);
}

// --- Нижняя статистика ---
async function updateStatistics(){
  const year=+document.getElementById("statsYearSelect").value;
  const {data:Income} = await supabase.from('income').select('*').eq('year',year);
  const {data:Payable} = await supabase.from('payable').select('*').eq('year',year);
  const container=document.getElementById("statisticsBlocks");
  container.innerHTML='';

  let totalEndCash=0,totalIncome=0,totalExpense=0;
  let memberStats={};
  FamilyMembers.forEach(p=>{
    memberStats[p]={income:0,expense:0,fair:0,diff:0};
    for(let m=1;m<=12;m++){
      const monthIncome=Income.filter(r=>r.person===p && r.month===m).reduce((a,b)=>a+b.amount,0);
      const manualTotal=Payable.find(r=>r.person===p && r.month===m && r.type==='manualTotal')?.amount||0;
      const personal = Payable.filter(r=>r.person===p && r.month===m && r.type==='personal').reduce((a,b)=>a+b.amount,0);
      const monthEndCash = startCash + monthIncome - (manualTotal-personal);
      const fair = (manualTotal-personal)*(monthIncome/Income.filter(i=>i.year===year).reduce((a,b)=>a+b.amount,0)||1);
      memberStats[p].income+=monthIncome;
      memberStats[p].expense+=(manualTotal-personal);
      memberStats[p].fair+=fair;
      memberStats[p].diff+=(manualTotal-personal-fair);
      totalEndCash+=monthEndCash;
      totalIncome+=monthIncome;
      totalExpense+=(manualTotal-personal);
    }
  });

  container.innerHTML+=`<div class="stat-block">Общий остаток: ${totalEndCash.toFixed(2)} €</div>`;
  container.innerHTML+=`<div class="stat-block">Средний доход: ${(totalIncome/12).toFixed(2)} €</div>`;
  container.innerHTML+=`<div class="stat-block">Средний расход: ${(totalExpense/12).toFixed(2)} €</div>`;

  FamilyMembers.forEach(p=>{
    container.innerHTML+=`<div class="stat-block"><b>${p}</b><br>Доход за год: ${memberStats[p].income.toFixed(2)} €<br>Расходы: ${memberStats[p].expense.toFixed(2)} €<br>Честная доля: ${memberStats[p].fair.toFixed(2)} €<br>Разница: ${memberStats[p].diff.toFixed(2)} €</div>`;
  });
}

// --- Инициализация ---
selectPerson('me');

</script>
</body>
</html>
